<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FILM MATCHER</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="main-container">
        <h1> FILM MATCHER</h1>
        <p>Write a word !! ONLY ENG (you can try with ITA but it's still in progress)</p>
        
        <div id="chat-history" class="chat-box">
            <div class="messaggio bot">Hiii, write a word about cinema and I will suggest you a film !</div>
        </div>

        <div class="input-area">
            <input type="text" id="userinput" placeholder="write a word for me!...">
            <button id="btnSearch" onclick="manda_richiesta()">SEARCH</button>
        </div>
    </div>

   <script>
       
        let paroleUsate = []; 
        let filmGiaVisti = []; 

        const paroleVietate = ["the", "a", "an", "and", "or", "of", "in", "on", "at", "yes", "no", "to", "is", "it", "with", "for", "by", "from", "hey", "hi"];

        function manda_richiesta() {
            let input = document.getElementById("userinput");
            let bottone = document.getElementById("btnSearch"); 
            
            if (!input) return;
            let text = input.value.trim(); 
            if(!text) return;

            
            let parolaPulita = text.toLowerCase();
            
           
            if (parolaPulita.length < 3) {
                addmessaggio(text, "user");
                input.value = "";
                addmessaggio("words with less than three letters are not allowed in this kingdom.", "bot");
                return; 
            }

            
            if (paroleVietate.includes(parolaPulita)) {
                addmessaggio(text, "user");
                input.value = "";
                addmessaggio("you can't use useless words, I don't have time to waste, give me a TOPIC (ex: 'cat', 'homer simpson', 'funny chatbot').", "bot");
                return; 
            }

            
            if (paroleUsate.includes(parolaPulita)) {
                addmessaggio(text, "user");
                input.value = "";
                addmessaggio("you have already write this word! come on write something else!", "bot");
                return; 
            }

            paroleUsate.push(parolaPulita);

            
            input.disabled = true;       
            bottone.disabled = true;     
            bottone.innerText = "...";   
            bottone.style.backgroundColor = "#555"; 
            
            addmessaggio(text, "user");
            input.value = "";

            
            let loaderId = addmessaggio("...", "bot");

            fetch('/ask', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({messaggio: text}) 
            })
            .then(r => r.json())
            .then(data => {
                
                
                let loaderDiv = document.getElementById(loaderId);
                if(loaderDiv) {
                    loaderDiv.remove(); 
                }

                
                let tempDiv = document.createElement('div');
                tempDiv.innerHTML = data.risposta;
                let titoloTrovato = tempDiv.querySelector('h3') ? tempDiv.querySelector('h3').innerText : null;

                if (titoloTrovato && filmGiaVisti.includes(titoloTrovato)) {
                    
                    addmessaggio(" My brain (or my database lol) suggests you <b>" + titoloTrovato + " another time</b>! Try with another word.", "bot");
                } else {
                    
                    if(titoloTrovato) {
                        filmGiaVisti.push(titoloTrovato);
                    }
                    addmessaggio(data.risposta, "bot");
                }
                
                riabilitaTutto(input, bottone);
            })
            .catch(error => {
                console.error("Errore:", error);
                
                let loaderDiv = document.getElementById(loaderId);
                if(loaderDiv) loaderDiv.remove();

                addmessaggio("connection error :(", "bot");
                riabilitaTutto(input, bottone);
            });
        }

        function riabilitaTutto(input, bottone) {
            input.disabled = false;
            bottone.disabled = false;
            bottone.innerText = "SEARCH";
            bottone.style.backgroundColor = "#007bff"; 
            input.focus(); 
        }

        function vote(tipo, film, query, btnElement) {
            
            let parent = btnElement.parentElement;
            parent.innerHTML = "<i>Thanks for your feedback! :)</i>"; 

            fetch('/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    voto: tipo,    
                    film: film,     
                    query: query    
                })
            })
            .then(r => r.json())
            .then(data => { console.log("feedback saved"); });
        }

        function addmessaggio(html, type) {
            let box = document.getElementById("chat-history");
            let div = document.createElement("div");
            let id = "msg-" + Date.now(); 
            div.id = id;
            div.className = "messaggio " + type; 
            
            if (type === 'user') {
                div.textContent = html; 
            } else {
                div.innerHTML = html;  
            }

            box.appendChild(div);
            box.scrollTop = box.scrollHeight; 
            return id;
        }
        
        document.getElementById("userinput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                if (!document.getElementById("userinput").disabled) {
                    manda_richiesta();
                }
            }
        });
    </script>
</body>
</html>